<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="m-0">Chat</h4>
        <small id="who" class="text-muted"></small>
      </div>
      <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
    </div>

    <!-- Room selection -->
    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-center">
        <div class="col-md-4">
          <select id="roomSelect" class="form-select">
            <option value="">Select a room</option>
            <option value="devops">devops</option>
            <option value="cloud computing">cloud computing</option>
            <option value="covid19">covid19</option>
            <option value="sports">sports</option>
            <option value="nodeJS">nodeJS</option>
          </select>
        </div>
        <div class="col-md-3">
          <button id="joinBtn" class="btn btn-primary w-100">Join Room</button>
        </div>
        <div class="col-md-3">
          <button id="leaveBtn" class="btn btn-secondary w-100">Leave Room</button>
        </div>
        <div class="col-md-2 text-end">
          <span id="currentRoom" class="badge text-bg-info d-none"></span>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div class="card p-3 mb-2" style="height: 320px; overflow-y: auto;">
      <ul id="messages" class="list-unstyled m-0"></ul>
    </div>

    <!-- Typing indicator -->
    <div id="typing" class="text-muted mb-3" style="min-height: 22px;"></div>

    <!-- Send message -->
    <div class="card p-3">
      <div class="row g-2">
        <div class="col-md-3">
          <input id="toUser" class="form-control" placeholder="To user (optional)" />
          <div class="form-text">Leave empty = room message</div>
        </div>
        <div class="col-md-7">
          <input id="msgInput" class="form-control" placeholder="Type your message..." />
        </div>
        <div class="col-md-2">
          <button id="sendBtn" class="btn btn-success w-100">Send</button>
        </div>
      </div>
    </div>

  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ===== session check =====
    const userRaw = localStorage.getItem("user");
    if (!userRaw) window.location.href = "/login";
    const user = JSON.parse(userRaw);
    document.getElementById("who").textContent = `Logged in as: ${user.username}`;

    // ===== socket =====
    const socket = io();
    socket.emit("registerUser", user.username);

    const roomSelect = document.getElementById("roomSelect");
    const joinBtn = document.getElementById("joinBtn");
    const leaveBtn = document.getElementById("leaveBtn");
    const currentRoom = document.getElementById("currentRoom");

    const messages = document.getElementById("messages");
    const typingDiv = document.getElementById("typing");

    const msgInput = document.getElementById("msgInput");
    const toUser = document.getElementById("toUser");
    const sendBtn = document.getElementById("sendBtn");

    let typingTimer = null;

    function addLine(text, muted = false) {
      const li = document.createElement("li");
      li.textContent = text;
      if (muted) li.classList.add("text-muted");
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    function renderGroupMessage(m) {
      const time = new Date(m.date_sent).toLocaleTimeString();
      addLine(`[${time}] ${m.from_user} @ ${m.room}: ${m.message}`);
    }

    function renderPrivateMessage(m) {
      const time = new Date(m.date_sent).toLocaleTimeString();
      addLine(`[${time}] (PM) ${m.from_user} -> ${m.to_user}: ${m.message}`);
    }

    function clearTypingLocal() {
      if (typingTimer) clearTimeout(typingTimer);
      typingTimer = null;
    }

    function stopTyping() {
      socket.emit("stopTyping");
    }

    // ===== Join / Leave =====
    joinBtn.addEventListener("click", () => {
      const room = roomSelect.value;
      if (!room) return;

      messages.innerHTML = "";
      typingDiv.textContent = "";

      socket.emit("joinRoom", { username: user.username, room });

      currentRoom.textContent = room;
      currentRoom.classList.remove("d-none");

      addLine(`You joined ${room}`, true);
    });

    leaveBtn.addEventListener("click", () => {
      socket.emit("leaveRoom");
      currentRoom.classList.add("d-none");
      typingDiv.textContent = "";
      addLine("You left the room", true);
      stopTyping();
      clearTypingLocal();
    });

    // ===== History / Incoming messages =====
    socket.on("roomHistory", (history) => {
      addLine("---- Room History (last 50) ----", true);
      history.forEach(renderGroupMessage);
      addLine("-------------------------------", true);
    });

    socket.on("newGroupMessage", (doc) => {
      renderGroupMessage(doc);
    });

    socket.on("newPrivateMessage", (doc) => {
      renderPrivateMessage(doc);
    });

    socket.on("system", (msg) => addLine(msg, true));

    // ===== Typing Indicator =====
    msgInput.addEventListener("input", () => {
      // Only show typing for room messages (not private message)
      // (private typing not required; keep simple)
      if (currentRoom.classList.contains("d-none")) return;

      socket.emit("typing");

      clearTypingLocal();
      typingTimer = setTimeout(() => {
        stopTyping();
      }, 800);
    });

    socket.on("typing", (text) => {
      typingDiv.textContent = text;
    });

    socket.on("stopTyping", () => {
      typingDiv.textContent = "";
    });

    // ===== Send message =====
    function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;

      const receiver = toUser.value.trim();

      // private message
      if (receiver) {
        socket.emit("privateMessage", { to_user: receiver, message: text });
      } else {
        // group message needs a joined room
        if (currentRoom.classList.contains("d-none")) {
          addLine("⚠️ Please join a room first.", true);
          return;
        }
        socket.emit("groupMessage", { message: text });
      }

      msgInput.value = "";
      stopTyping();
      clearTypingLocal();
    }

    sendBtn.addEventListener("click", sendMessage);

    // Enter to send
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

    // ===== logout =====
    document.getElementById("logoutBtn").addEventListener("click", () => {
      stopTyping();
      clearTypingLocal();
      localStorage.removeItem("user");
      window.location.href = "/login";
    });
  </script>
</body>
</html>

